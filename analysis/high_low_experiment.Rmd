---
title: "GEP Rank Simulation"
output:
  workflowr::wflow_html:
    code_folding: hide
date: "2025-08-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(ggplot2)
library(fastTopics)
library(log1pNMF)
```


## Introduction

Here, I wanted to do a simple simulation in order to demonstrate differences in how log1p models with different values of c prioritize genes differently. 

To do this, I created a 3-group simulation with some "low expressed genes" and some "high expressed genes". Specifically, the groups are constructed as:

A) Half of the low expressed genes are expressed at rate $\lambda = 3$, while the other half are expressed at $\lambda = 0$. Half the highly expressed genes are expressed at $\lambda = 1000$, where the other half are expressed at $\lambda = 1100$. 

B) The low expressed genes not expressed in A are expressed at $\lambda = 3$, where the low expressed genes which are expressed in A are not expressed ($\lambda = 0$). Similarly, the high expressed genes that are most expressed in group A ($\lambda = 1100$) are less expressed in group B at $\lambda = 1000$, where the remaining genes which are lower expressed in group A ($\lambda = 1100$) are expressed at $\lambda = 1100$ in group B.

C) None of the low expressed genes are expressed at all, where all high expressed genes are expressed at $\lambda = 1051.5$. 

The intuition here is that both the log1p model with small $c$ and the topic model should fit a baseline, and one factor each to capture the differences between A and C and B and C, respectively. However, the ranking of the genes should be very different between the two models, where the "difference" factors in the log1p model will rank the low expressed genes higher than the high expressed genes, and the topic model will do the opposite.

I demonstrate that this is indeed the case below.

## Simulation

```{r}
high_expressed_genes <- 500
low_expressed_genes <- 500

p <- high_expressed_genes + low_expressed_genes
n <- 1000

LL <- matrix(
  data = c(
    rep(1, 333), rep(0, 1000 - 333),
    rep(0, 333), rep(1, 333), rep(0, 334),
    rep(0, 1000 - 334), rep(1, 334)
  ),
  nrow = n,
  ncol = 3
)


FF <- matrix(
  data = c(
    rep(3, round(low_expressed_genes / 2)), 
    rep(0, round(low_expressed_genes / 2)),
    rep(1100, round(high_expressed_genes / 2)),
    rep(1000, round(high_expressed_genes / 2)),
    rep(0, round(low_expressed_genes / 2)), 
    rep(3, round(low_expressed_genes / 2)),
    rep(1000, round(high_expressed_genes / 2)),
    rep(1100, round(high_expressed_genes / 2)),
    rep(0, round(low_expressed_genes / 2)), 
    rep(0, round(low_expressed_genes / 2)),
    rep(1051.5, round(high_expressed_genes / 2)),
    rep(1051.5, round(high_expressed_genes / 2))
  ),
  nrow = p,
  ncol = 3
)

Lambda <- tcrossprod(LL, FF)
set.seed(1)
Y <- matrix(
  data = rpois(n = n * p, lambda = as.vector(Lambda)),
  nrow = n,
  ncol = p
)

library(fastTopics)
rownames(Y) <- paste0("cell", 1:n)
colnames(Y) <- paste0("gene", 1:p)
```

Below is a plot of expression by group:

```{r}
expr_df <- data.frame(
  group = c(
    rep("A", 1000), rep("B", 1000), rep("C", 1000)
  ),
  gene_id = c(
    1:1000, 1:1000, 1:1000
  ),
  expr = c(
    rep(3, round(low_expressed_genes / 2)), 
    rep(0, round(low_expressed_genes / 2)),
    rep(1100, round(high_expressed_genes / 2)),
    rep(1000, round(high_expressed_genes / 2)),
    rep(0, round(low_expressed_genes / 2)), 
    rep(3, round(low_expressed_genes / 2)),
    rep(1000, round(high_expressed_genes / 2)),
    rep(1100, round(high_expressed_genes / 2)),
    rep(0, round(low_expressed_genes / 2)), 
    rep(0, round(low_expressed_genes / 2)),
    rep(1051.5, round(high_expressed_genes / 2)),
    rep(1051.5, round(high_expressed_genes / 2))
  )
)

ggplot(expr_df, aes(x = gene_id, y = log1p(expr))) +
  geom_bar(stat = "identity") +  # Use bars to represent lambda values
  facet_wrap(~ group) +          # Create a panel for each group
  labs(x = "Gene", y = "log1p(Expression)") +
  cowplot::theme_cowplot()  # Use a minimal theme for a clean look
```

Now, we fit both the log1p model with $c = 1$ and the topic model with a rank-1 initialization. 

Below is a structure plot of the topic model (normalizing so that the maximum loading for each factor is $1$).

```{r}
ft_r1 <- fastTopics:::fit_pnmf_rank1(Y)
init_LL <- cbind(
  ft_r1$L,
  matrix(
    data = 1e-3,
    nrow = n,
    ncol = 2
  )
)
rownames(init_LL) <- rownames(Y)

init_FF <- cbind(
  ft_r1$F,
  matrix(
    data = 1e-3,
    nrow = p,
    ncol = 2
  )
)
rownames(init_FF) <- colnames(Y)

ft_init <- init_poisson_nmf(X = Y, F = init_FF, L = init_LL)

ft_mod <- fit_poisson_nmf(X = Y, fit0 = ft_init, verbose = "none")

group <- c(rep("A", 333), rep("B", 333), rep("C", 334))


structure_plot(log1pNMF:::normalize_bars(ft_mod$L), grouping = group, gap = 10, loadings_order = 1:n, topics = rev(1:3)) + 
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5, size = 12)) + ylab("Membership")

```

And here is the log1p model:

```{r}
set.seed(1)
log1p_mod <- fit_poisson_log1p_nmf(
  Y = Y, K = 3, loglik = "exact",
  control = list(maxiter = 250, verbose = FALSE)
)

colnames(log1p_mod$LL) <- paste0("k", 1:3)
colnames(log1p_mod$FF) <- paste0("k", 1:3)

LL <- log1p_mod$LL
FF <- log1p_mod$FF

log1p_mod$LL[,"k2"] <- LL[,"k3"]
log1p_mod$LL[,"k3"] <- LL[,"k2"]

log1p_mod$FF[,"k2"] <- FF[,"k3"]
log1p_mod$FF[,"k3"] <- FF[,"k2"]

normalized_structure_plot(
  log1p_mod, 
  grouping = group, 
  gap = 10,
  loadings_order = 1:n,
  topics = rev(1:3)
  ) + 
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5, size = 12)) + ylab("Membership")
```
The structure plots are nearly identical, as expected. 

```{r}
# NOTE: need to normalize these based on the max-1 normalization above
max_col <- apply(log1p_mod$FF, 2, max)
log1p_FF <- sweep(log1p_mod$FF, 2, max_col, FUN = "*")

max_col <- apply(ft_mod$F, 2, max)
tm_FF <- sweep(ft_mod$F, 2, max_col, FUN = "*")
colnames(tm_FF) <- paste0("k", 1:3)

k2_df <- data.frame(
  model = c(
    rep("Topic Model", 1000),
    rep("log1p Model", 1000)
  ),
  factor_value = c(
    log1p(tm_FF[,"k2"]),
    log1p_FF[,"k2"]
  ),
  gene_type = c(
    rep("Low On", 250),
    rep("Low Off", 250),
    rep("High Up", 250),
    rep("High Down", 250)
  )
)

k3_df <- data.frame(
  model = c(
    rep("Topic Model", 1000),
    rep("log1p Model", 1000)
  ),
  factor_value = c(
    log1p(tm_FF[,"k3"]),
    log1p_FF[,"k3"]
  ),
  gene_type = c(
    rep("Low Off", 250),
    rep("Low On", 250),
    rep("High Down", 250),
    rep("High Up", 250)
  )
)

```

However, there are very large differences in the ranking of genes when comparing factors 2 and 3 between the topic model and the log1p model. Below I have plotted factor values (were I log1p transformed factors from the topic model for visibility). Below is factor 2:

```{r}
ggplot(k2_df, aes(x = factor_value, fill = gene_type)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 60) +
  cowplot::theme_cowplot() +
  facet_wrap(~model, scales = "free") +
  xlab("Factor Value")
```

Factor 3 looks nearly the same:

```{r}
ggplot(k3_df, aes(x = factor_value, fill = gene_type)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 60) +
  cowplot::theme_cowplot() +
  facet_wrap(~model, scales = "free") +
  xlab("Factor Value")
```

Essentially, what we are seeing is that in the log1p model, the genes that go from "off" ($\lambda = 0$) to on ($\lambda = 3$), which I term "Low on", are prioritized in the factors of the log1p model. This makes sense, because on the log1p scale, going from $0$ to $3$ is a much greater change than going from $1000$ to $1100$. On the other hand, the topic model clearly prioritizes the genes that go from $1000$ to $1100$ in the relevant group ("High Up"). In fact, likely due to noise, many of the "High Down" genes are ranked higher than the low on genes. 

Finally, I was curious what GLM-PCA would do with this dataset.

```{r, warning=FALSE, message=FALSE}
library(fastglmpca)
set.seed(1)
gpca_fit <- fit_glmpca_pois(
  Y = t(Y),
  K = 2,
  control = list(maxiter = 500),
  verbose = FALSE
)

gpca_df <- as.data.frame(gpca_fit$V)
gpca_df$group <- group

ggplot(data = gpca_df, aes(x = k_1, y = k_2)) +
  geom_point(aes(color = group)) +
  xlab("PC1") + 
  ylab("PC2") +
  cowplot::theme_cowplot()
```


